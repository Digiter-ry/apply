services:
  php:
    image: php:8.2-fpm-alpine
    container_name: dev-apply-php
    working_dir: /srv/app
    networks: [edge]
    # vain app-env suoraan; API-avaimet menevät env_file:llä
    environment:
      APP_ENV: development
    env_file:
      - /home/infra/env/apply.env
    volumes:
      - .:/srv/app:rw
      - /home/infra/env:/secrets:ro
    restart: unless-stopped

  web:
    image: nginx:1.27-alpine
    container_name: dev-apply-web
    depends_on: [php]
    networks: [edge]
    volumes:
      - ./:/srv/app:rw
      - ./conf/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    expose:
      - "80"
    restart: unless-stopped

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:latest
    container_name: dev-apply-oauth2
    restart: unless-stopped
    env_file:
      - /home/infra/env/apply.env
    # Porttimäppäys ei ole pakollinen, mutta helpottaa pikadiagnoosia.
    # Voit jättää tämän pois tuotannossa.
    ports:
      - "4180:4180"
    networks:
      - edge     # sama verkko kuin Caddylla
      - default  # sama verkko kuin dev-apply-web ja -php

networks:
  edge:
    external: true
